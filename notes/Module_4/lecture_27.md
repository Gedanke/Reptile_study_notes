# JavaScript 混淆技术

在爬取网站的时候，经常会遇到各种各样类似加密的情形，比如：

* 某个网站的 ```URL``` 带有一些看不懂的长串加密参数，想要抓取就必须要懂得这些参数是怎么构造的，否则我们连完整的 URL 都构造不出来，更不用说爬取了
* 分析某个网站的 ```Ajax``` 接口的时候，可以看到接口的一些参数也是加密的，或者 ```Request Headers```
  里面也可能带有一些加密参数，如果不知道这些参数的具体构造逻辑就无法直接用程序来模拟这些 ```Ajax``` 请求
* 翻看网站的 ```JavaScript``` 源代码，可以发现很多压缩了或者看不太懂的字符，比如 ```JavaScript``` 文件名被编码，```JavaScript``` 的文件内容被压缩成几行，```JavaScript```
  变量也被修改成单个字符或者一些十六进制的字符，导致我们不好轻易根据 ```JavaScript``` 找出某些接口的加密逻辑

这些情况，基本上都是网站为了保护其本身的一些数据不被轻易抓取而采取的一些措施，我们可以把它归为两大类：

* 接口加密技术
* ```JavaScript``` 压缩、混淆和加密技术

本课时我们就来了解下这两类技术的实现原理。

---
---

## 数据保护

当今大数据时代，数据已经变得越来越重要，网页和 App 现在是主流的数据载体，如果其数据的接口没有设置任何保护措施，在爬虫工程师解决了一些基本的反爬如封 IP、验证码的问题之后，那么数据还是可以被轻松抓取到。

那么，有没有可能在接口或 ```JavaScript``` 层面也加上一层防护呢？答案是可以的。

---

## 接口加密技术

网站运营商首先想到防护措施可能是对某些数据接口进行加密，比如说对某些 URL 的一些参数加上校验码或者把一些 ID 信息进行编码，使其变得难以阅读或构造；或者对某些接口请求加上一些 ```token、sign```
等签名，这样这些请求发送到服务器时，服务器会通过客户端发来的一些请求信息以及双方约定好的秘钥等来对当前的请求进行校验，如果校验通过，才返回对应数据结果。

比如说客户端和服务端约定一种接口校验逻辑，客户端在每次请求服务端接口的时候都会附带一个 ```sign``` 参数，这个 ```sign``` 参数可能是由当前时间信息、请求的 ```URL```、请求的数据、设备的
ID、双方约定好的秘钥经过一些加密算法构造而成的，客户端会实现这个加密算法构造 ```sign```，然后每次请求服务器的时候附带上这个参数。服务端会根据约定好的算法和请求的数据对 ```sign```
进行校验，如果校验通过，才返回对应的数据，否则拒绝响应。

---

## JavaScript 压缩、混淆和加密技术

接口加密技术看起来的确是一个不错的解决方案，但单纯依靠它并不能很好地解决问题。为什么呢？

对于网页来说，其逻辑是依赖于 ```JavaScript``` 来实现的，```JavaScript``` 有如下特点：

* ```JavaScript``` 代码运行于客户端，也就是它必须要在用户浏览器端加载并运行
* ```JavaScript``` 代码是公开透明的，也就是说浏览器可以直接获取到正在运行的 ```JavaScript``` 的源码

由于这两个原因，导致 ```JavaScript``` 代码是不安全的，任何人都可以读、分析、复制、盗用，甚至篡改。

所以说，对于上述情形，客户端 ```JavaScript``` 对于某些加密的实现是很容易被找到或模拟的，了解了加密逻辑后，模拟参数的构造和请求也就是轻而易举了，所以如果 JavaScript
没有做任何层面的保护的话，接口加密技术基本上对数据起不到什么防护作用。

如果你不想让自己的数据被轻易获取，不想他人了解 ```JavaScript``` 逻辑的实现，或者想降低被不怀好意的人甚至是黑客攻击。那么你就需要用到 ```JavaScript``` 压缩、混淆和加密技术了。

这里压缩、混淆、加密技术简述如下。

* 代码压缩：即去除 ```JavaScript``` 代码中的不必要的空格、换行等内容，使源码都压缩为几行内容，降低代码可读性，当然同时也能提高网站的加载速度
* 代码混淆：使用变量替换、字符串阵列化、控制流平坦化、多态变异、僵尸函数、调试保护等手段，使代码变得难以阅读和分析，达到最终保护的目的。但这不影响代码原有功能。是理想、实用的 ```JavaScript``` 保护方案
* 代码加密：可以通过某种手段将 ```JavaScript``` 代码进行加密，转成人无法阅读或者解析的代码，如将代码完全抽象化加密，如 ```eval``` 加密。另外还有更强大的加密技术，可以直接将 ```JavaScript```
  代码用 ```C/C++``` 实现，```JavaScript``` 调用其编译后形成的文件来执行相应的功能，如 ```Emscripten``` 还有 ```WebAssembly```

下面我们对上面的技术分别予以介绍。

---

## 接口加密技术

数据一般都是通过服务器提供的接口来获取的，网站或 App 可以请求某个数据接口获取到对应的数据，然后再把获取的数据展示出来。

但有些数据是比较宝贵或私密的，这些数据肯定是需要一定层面上的保护。所以不同接口的实现也就对应着不同的安全防护级别，我们这里来总结下。

---

### 完全开放的接口

有些接口是没有设置任何防护的，谁都可以调用和访问，而且没有任何时空限制和频率限制。任何人只要知道了接口的调用方式就能无限制地调用。

这种接口的安全性是非常非常低的，如果接口的调用方式一旦泄露或被抓包获取到，任何人都可以无限制地对数据进行操作或访问。此时如果接口里面包含一些重要的数据或隐私数据，就能轻易被篡改或窃取了。

---

### 接口参数加密

为了提升接口的安全性，客户端会和服务端约定一种接口校验方式，一般来说会使用到各种加密和编码算法，如 ```Base64、Hex``` 编码，```MD5、AES、DES、RSA``` 等加密。

比如客户端和服务器双方约定一个 ```sign``` 用作接口的签名校验，其生成逻辑是客户端将 ```URL Path``` 进行 ```MD5``` 加密然后拼接上 ```URL``` 的某个参数再进行 ```Base64```
编码，最后得到一个字符串 ```sign```，这个 ```sign``` 会通过 ```Request URL``` 的某个参数或 ```Request Headers```
发送给服务器。服务器接收到请求后，对 ```URL Path``` 同样进行 ```MD5``` 加密，然后拼接上 ```URL``` 的某个参数，也进行 ```Base64``` 编码得到了一个 ```sign```
，然后比对生成的 ```sign``` 和客户端发来的 ```sign```
是否是一致的，如果是一致的，那就返回正确的结果，否则拒绝响应。这就是一个比较简单的接口参数加密的实现。如果有人想要调用这个接口的话，必须要定义好 ```sign```
的生成逻辑，否则是无法正常调用接口的。

以上就是一个基本的接口参数加密逻辑的实现。

当然上面的这个实现思路比较简单，这里还可以增加一些时间戳信息增加时效性判断，或增加一些非对称加密进一步提高加密的复杂程度。但不管怎样，只要客户端和服务器约定好了加密和校验逻辑，任何形式加密算法都是可以的。

这里要实现接口参数加密就需要用到一些加密算法，客户端和服务器肯定也都有对应的 SDK 实现这些加密算法，如 ```JavaScript``` 的 ```crypto-js```，```Python```
的 ```hashlib、Crypto``` 等等。

但还是如上文所说，如果是网页的话，客户端实现加密逻辑如果是用 ```JavaScript``` 来实现，其源代码对用户是完全可见的，如果没有对 ```JavaScript``` 做任何保护的话，是很容易弄清楚客户端加密的流程的。

因此，我们需要对 ```JavaScript``` 利用压缩、混淆、加密的方式来对客户端的逻辑进行一定程度上的保护。

---

## JavaScript 压缩、混淆、加密

下面我们再来介绍下 ```JavaScript``` 的压缩、混淆和加密技术。

---

### JavaScript 压缩

这个非常简单，```JavaScript``` 压缩即去除 ```JavaScript```
代码中的不必要的空格、换行等内容或者把一些可能公用的代码进行处理实现共享，最后输出的结果都被压缩为几行内容，代码可读性变得很差，同时也能提高网站加载速度。

如果仅仅是去除空格换行这样的压缩方式，其实几乎是没有任何防护作用的，因为这种压缩方式仅仅是降低了代码的直接可读性。如果我们有一些格式化工具可以轻松将 ```JavaScript``` 代码变得易读，比如利用
IDE、在线工具或 ```Chrome``` 浏览器都能还原格式化的代码。

目前主流的前端开发技术大多都会利用 ```Webpack``` 进行打包，```Webpack``` 会对源代码进行编译和压缩，输出几个打包好的 ```JavaScript```
文件，其中我们可以看到输出的 ```JavaScript``` 文件名带有一些不规则字符串，同时文件内容可能只有几行内容，变量名都是一些简单字母表示。这其中就包含 ```JavaScript```
压缩技术，比如一些公共的库输出成 ```bundle``` 文件，一些调用逻辑压缩和转义成几行代码，这些都属于 ```JavaScript``` 压缩。另外其中也包含了一些很基础的 ```JavaScript```
混淆技术，比如把变量名、方法名替换成一些简单字符，降低代码可读性。

但整体来说，```JavaScript``` 压缩技术只能在很小的程度上起到防护作用，要想真正提高防护效果还得依靠 ```JavaScript``` 混淆和加密技术。

---

### JavaScript 混淆

```JavaScript``` 混淆完全是在 ```JavaScript``` 上面进行的处理，它的目的就是使得 ```JavaScript``` 变得难以阅读和分析，大大降低代码可读性，是一种很实用的 ```JavaScript```
保护方案。

```JavaScript``` 混淆技术主要有以下几种：

* 变量混淆: 将带有含意的变量名、方法名、常量名随机变为无意义的类乱码字符串，降低代码可读性，如转成单个字符或十六进制字符串
* 字符串混淆: 将字符串阵列化集中放置、并可进行 ```MD5``` 或 ```Base64``` 加密存储，使代码中不出现明文字符串，这样可以避免使用全局搜索字符串的方式定位到入口点
* 属性加密: 针对 ```JavaScript``` 对象的属性进行加密转化，隐藏代码之间的调用关系
* 控制流平坦化: 打乱函数原有代码执行流程及函数调用关系，使代码逻变得混乱无序
* 僵尸代码: 随机在代码中插入无用的僵尸代码、僵尸函数，进一步使代码混乱
* 调试保护: 基于调试器特性，对当前运行环境进行检验，加入一些强制调试 ```debugger``` 语句，使其在调试模式下难以顺利执行 ```JavaScript``` 代码
* 多态变异: 使 ```JavaScript``` 代码每次被调用时，将代码自身即立刻自动发生变异，变化为与之前完全不同的代码，即功能完全不变，只是代码形式变异，以此杜绝代码被动态分析调试
* 锁定域名: 使 ```JavaScript``` 代码只能在指定域名下执行
* 反格式化: 如果对 ```JavaScript``` 代码进行格式化，则无法执行，导致浏览器假死
* 特殊编码: 将 ```JavaScript``` 完全编码为人不可读的代码，如表情符号、特殊表示内容等等

总之，以上方案都是 ```JavaScript``` 混淆的实现方式，可以在不同程度上保护 ```JavaScript``` 代码。


---
---


